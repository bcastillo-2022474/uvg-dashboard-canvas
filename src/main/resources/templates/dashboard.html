<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.expanded {
            max-height: 500px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #3B82F6 var(--progress, 0%), #E5E7EB var(--progress, 0%));
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-3 md:p-6">
<div class="max-w-7xl mx-auto space-y-4">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <div class="h-10 w-10 md:h-12 md:w-12 ring-2 ring-blue-100 rounded-full bg-blue-500 flex items-center justify-center text-white font-semibold">
                JD
            </div>
            <div>
                <h1 class="text-xl md:text-2xl font-bold text-gray-900">Welcome back, <span th:text="${userName ?: 'Student'}"></span> ðŸ‘‹</h1>
                <p class="text-sm md:text-base text-gray-600">All your course data in one place</p>
            </div>
        </div>
        <div class="flex items-center space-x-2">
            <button class="relative bg-transparent h-8 w-8 md:h-10 md:w-10 border border-gray-300 rounded-md flex items-center justify-center hover:bg-gray-50">
                <i data-lucide="bell" class="h-3 w-3 md:h-4 md:w-4"></i>
                <span class="absolute -top-1 -right-1 h-2 w-2 md:h-3 md:w-3 bg-red-500 rounded-full"></span>
            </button>
            <a href="/logout" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm font-medium transition duration-150 ease-in-out">
                Logout
            </a>
        </div>
    </div>

    <!-- Enhanced Summary Widgets -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="shadow-sm border-0 bg-white/70 backdrop-blur-sm rounded-lg p-3 md:p-4">
            <div class="flex items-center space-x-2">
                <i data-lucide="target" class="h-4 w-4 md:h-5 md:w-5 text-blue-600"></i>
                <div>
                    <p class="text-xs md:text-sm text-gray-600">Overall</p>
                    <p class="text-lg md:text-2xl font-bold text-blue-600" th:text="${#numbers.formatDecimal(dashboardData.summary.overallPercentage, 1, 1)} + '%'" ></p>
                    <p class="text-xs text-gray-500">Semester</p>
                </div>
            </div>
        </div>

        <div class="shadow-sm border-0 bg-white/70 backdrop-blur-sm rounded-lg p-3 md:p-4">
            <div class="flex items-center space-x-2">
                <i data-lucide="bar-chart-3" class="h-4 w-4 md:h-5 md:w-5 text-green-600"></i>
                <div>
                    <p class="text-xs md:text-sm text-gray-600">Graded</p>
                    <p class="text-lg md:text-2xl font-bold text-green-600" th:text="${#numbers.formatDecimal(dashboardData.summary.totalGradedPercentage, 1, 1)} + '%'" ></p>
                    <p class="text-xs text-gray-500" th:text="${dashboardData.summary.totalGradedPoints} + '/' + ${dashboardData.summary.totalGradedPointsPossible}" ></p>
                </div>
            </div>
        </div>

        <div class="shadow-sm border-0 bg-white/70 backdrop-blur-sm rounded-lg p-3 md:p-4">
            <div class="flex items-center space-x-2">
                <i data-lucide="check-circle" class="h-4 w-4 md:h-5 md:w-5 text-purple-600"></i>
                <div>
                    <p class="text-xs md:text-sm text-gray-600">Completed</p>
                    <p class="text-lg md:text-2xl font-bold text-purple-600" th:text="${dashboardData.summary.totalCompletedAssignments}" ></p>
                    <p class="text-xs text-gray-500">assignments</p>
                </div>
            </div>
        </div>

        <div class="shadow-sm border-0 bg-white/70 backdrop-blur-sm rounded-lg p-3 md:p-4">
            <div class="flex items-center space-x-2">
                <i data-lucide="alert-triangle" class="h-4 w-4 md:h-5 md:w-5 text-orange-600"></i>
                <div>
                    <p class="text-xs md:text-sm text-gray-600">Due Soon</p>
                    <p class="text-lg md:text-2xl font-bold text-orange-600" th:text="${dashboardData.summary.upcomingAssignments}" ></p>
                    <p class="text-xs text-gray-500">this week</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Widgets Row -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Weekly Summary -->
        <div class="shadow-sm border-0 bg-white/70 backdrop-blur-sm rounded-lg">
            <div class="p-4 pb-3">
                <h3 class="text-lg font-semibold flex items-center space-x-2">
                    <i data-lucide="calendar" class="h-5 w-5 text-green-600"></i>
                    <span>This Week</span>
                </h3>
            </div>
            <div class="p-4 pt-0">
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Tasks Completed</span>
                        <span class="font-semibold"></span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Points Earned</span>
                        <span class="font-semibold text-green-600"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Predicted Final Grade -->
        <div class="shadow-sm border-0 bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg">
            <div class="text-center p-4 pb-3">
                <h3 class="text-lg font-semibold flex items-center justify-center space-x-2">
                    <i data-lucide="graduation-cap" class="h-5 w-5 text-green-600"></i>
                    <span>Predicted Grade</span>
                </h3>
            </div>
            <div th:if="${predictionData.isPredictionAvailable()}" class="text-center p-4 pt-0">
                <div class="text-3xl font-bold text-green-600 mb-2" th:text="${#numbers.formatDecimal(predictionData.predictedScore, 1, 1)} + '%'" ></div>
                <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded" th:text="'On Track for ' + ${predictionData.predictedLetterGrade}"></span>
            </div>
            <div th:if="${!predictionData.isPredictionAvailable()}" class="text-center p-4 pt-0">
                <p class="text-sm text-gray-600 p-4">Not enough data to make a prediction.</p>
            </div>
        </div>

        <!-- Points Summary -->
        <div class="shadow-sm border-0 bg-white/70 backdrop-blur-sm rounded-lg">
            <div class="p-4 pb-3">
                <h3 class="text-lg font-semibold">Points Summary</h3>
            </div>
            <div class="p-4 pt-0 space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Total Semester</span>
                    <span class="font-semibold" th:text="${dashboardData.summary.totalGradedPoints} + '/' + ${dashboardData.summary.totalSemesterPointsPossible}"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Graded Only</span>
                    <span class="font-semibold text-green-600" th:text="${dashboardData.summary.totalGradedPoints} + '/' + ${dashboardData.summary.totalGradedPointsPossible}"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Remaining</span>
                    <span class="font-semibold text-blue-600" th:text="${dashboardData.summary.totalUpcomingPoints}"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Course Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
<!-- Dynamic Course Cards -->
<div th:each="courseCard, iterStat : ${dashboardData.courseCards}"
     class="shadow-sm border-0 bg-white/80 backdrop-blur-sm hover:bg-white/90 hover:scale-101 transition-all duration-200 rounded-lg">

    <!-- Course Header -->
    <div class="p-4 pb-3">
        <div class="flex items-start justify-between">
            <div class="flex items-center space-x-2">
                <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                <div>
                    <h3 class="font-semibold text-sm md:text-base text-gray-900 leading-tight"
                        th:text="${courseCard.courseWithGrades.course.name}"></h3>
                    <p class="text-xs text-gray-600"
                       th:text="${courseCard.courseWithGrades.course.code}"></p>
                </div>
            </div>
            <div class="text-right">
                <span class="bg-gray-100 text-gray-800 text-sm px-2 py-1 rounded"
                      th:text="${courseCard.courseWithGrades.enrollment.currentGrade}"></span>
                <div class="flex items-center mt-1">
                    <span class="text-lg font-bold text-blue-600"
                          th:text="${#numbers.formatDecimal(courseCard.courseWithGrades.enrollment.currentScore, 1, 1)} + '%'" ></span>
                    <i th:data-lucide="${courseCard.trend == 'up' ? 'trending-up' : (courseCard.trend == 'down' ? 'trending-down' : 'minus')}"
                       th:class="${'h-3 w-3 ml-1 ' + (courseCard.trend == 'up' ? 'text-green-500' : (courseCard.trend == 'down' ? 'text-red-500' : 'text-gray-400'))}"
                       class="h-3 w-3 text-green-500 ml-1"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="p-4 pt-0 space-y-4">
        <!-- Points Summary (removed semester points to simplify) -->
        <div class="grid grid-cols-2 gap-3 text-xs">
            <div class="bg-blue-50 p-2 rounded">
                <p class="text-blue-600 font-medium">Current Score</p>
                <p class="font-bold text-blue-800"
                   th:text="${#numbers.formatDecimal(courseCard.courseWithGrades.enrollment.currentScore, 1, 1)} + '%'" ></p>
            </div>
            <div class="bg-gray-50 p-2 rounded">
                <p class="text-gray-600 font-medium">Remaining</p>
                <p class="font-bold text-gray-800" th:text="${#numbers.formatDecimal(courseCard.remainingPoints, 1, 0)} + '%'"></p>
            </div>
        </div>

        <!-- Recent Grades -->
        <div th:if="${!courseCard.recentGrades.isEmpty()}">
            <button th:onclick="'toggleGrades(\'course-' + ${iterStat.index} + '\')'"
                    class="w-full justify-between p-2 h-auto text-left hover:bg-gray-50 rounded flex items-center">
                <span class="text-xs font-semibold text-gray-700"
                      th:text="'Recent Grades (' + ${courseCard.recentGrades.size()} + ')'"></span>
                <i data-lucide="chevron-down" class="h-3 w-3" th:id="'course-' + ${iterStat.index} + '-chevron'"></i>
            </button>
            <div th:id="'course-' + ${iterStat.index} + '-grades'" class="collapsible-content space-y-1 mt-2">
                <div th:each="recentGrade : ${courseCard.recentGrades}"
                     class="flex justify-between items-center text-xs bg-gray-50 p-2 rounded">
                    <div class="flex-1 mr-2">
                        <span class="truncate block" th:text="${recentGrade.assignment.name}"></span>
                        <span class="text-gray-500"
                              th:text="${recentGrade.submission.gradedAt != null ? #temporals.format(recentGrade.submission.gradedAt, 'MMM dd') : 'N/A'}"></span>
                    </div>
                    <div class="text-right">
                        <span class="font-semibold text-green-600"
                              th:text="${recentGrade.submission.score != null and recentGrade.assignment.pointsPossible > 0 ? #numbers.formatDecimal((recentGrade.submission.score / recentGrade.assignment.pointsPossible) * 100, 1, 0) + '%' : 'N/A'}"></span>
                        <p class="text-gray-500"
                           th:text="${recentGrade.submission.score != null ? recentGrade.submission.score : '-'} + '/' + ${recentGrade.assignment.pointsPossible}"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Breakdown -->
        <div th:if="${!courseCard.categoryBreakdown.isEmpty()}">
            <h4 class="text-xs font-semibold text-gray-700 mb-2">Grade Categories</h4>
            <div class="space-y-1">
                <div th:each="category : ${courseCard.categoryBreakdown}"
                     class="flex justify-between items-center text-xs">
                    <span class="text-gray-600"
                          th:text="${category.group.name} + ' (' + ${#numbers.formatDecimal(category.group.groupWeight, 1, 0)} + '%)'"></span>
                    <div class="text-right">
                        <span class="font-medium"
                              th:text="${#numbers.formatDecimal(category.currentScore, 1, 0)} + '%'" ></span>
                        <p class="text-gray-500"
                           th:text="${category.pointsEarned} + '/' + ${category.pointsTotal}"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upcoming Assignments -->
        <div th:if="${!courseCard.upcomingAssignments.isEmpty()}">
            <h4 class="text-xs font-semibold text-gray-700 mb-2">Due Soon</h4>
            <div class="space-y-1">
                <div th:each="assignment : ${courseCard.upcomingAssignments}"
                     class="flex items-center justify-between text-xs bg-amber-50 p-2 rounded border border-amber-200">
                    <div class="flex items-center space-x-1">
                        <i data-lucide="file-text" class="h-3 w-3"></i>
                        <span class="truncate" th:text="${assignment.name}"></span>
                    </div>
                    <div class="text-right">
                        <p class="font-medium text-amber-800"
                           th:text="${assignment.dueAt != null ? #temporals.format(assignment.dueAt, 'MMM dd') : 'No due date'}"></p>
                        <p class="text-amber-600"
                           th:text="${assignment.pointsPossible} + ' pts'"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- No upcoming assignments message -->
        <div th:if="${courseCard.upcomingAssignments.isEmpty()}"
             class="bg-green-50 border border-green-200 p-2 rounded">
            <div class="flex items-center space-x-1">
                <i data-lucide="check-circle" class="h-3 w-3 text-green-500"></i>
                <span class="text-xs text-green-800 font-medium">No upcoming assignments!</span>
            </div>
        </div>
    </div>
</div>
    </div>

    <!-- Grade Progression Chart -->
    <div class="shadow-sm border-0 bg-white/70 backdrop-blur-sm rounded-lg" th:if="${predictionData.isPredictionAvailable()}">
        <div class="p-4 pb-3">
            <h3 class="text-lg font-semibold flex items-center space-x-2">
                <i data-lucide="trending-up" class="h-5 w-5 text-purple-600"></i>
                <span>Overall Grade Progression</span>
            </h3>
            <p class="text-sm text-gray-600">Your academic performance trend over time</p>
        </div>
        <div class="p-4 pt-0 overflow-x-auto">
            <svg id="progressionChart" class="h-[300px]" preserveAspectRatio="none">
                <!-- Gradient for area under line -->
                <defs>
                    <linearGradient id="lineGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#9333ea;stop-opacity:0.2" />
                        <stop offset="100%" style="stop-color:#9333ea;stop-opacity:0" />
                    </linearGradient>
                </defs>

                <!-- Grid lines (will be added dynamically) -->
                <g id="gridLines"></g>

                <!-- Y-axis labels (will be added dynamically) -->
                <g id="yAxisLabels"></g>

                <!-- Area fill -->
                <polygon id="areaFill" fill="url(#lineGradient)"/>

                <!-- The line -->
                <polyline id="trendLine" stroke="#9333ea" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/>

                <!-- Data points -->
                <g id="dataPoints"></g>
            </svg>

            <script th:inline="javascript">
                /*<![CDATA[*/
                (function() {
                    const data = /*[[${predictionData.gradeProgression}]]*/ [];
                    if (!data || data.length === 0) return;

                    const svg = document.getElementById('progressionChart');
                    const trendLine = document.getElementById('trendLine');
                    const areaFill = document.getElementById('areaFill');
                    const dataPointsGroup = document.getElementById('dataPoints');
                    const gridLines = document.getElementById('gridLines');
                    const yAxisLabels = document.getElementById('yAxisLabels');

                    // Configuration
                    const leftMargin = 60;
                    const rightMargin = 20;
                    const topMargin = 30;
                    const bottomMargin = 40;
                    const pointSpacing = 80; // More space between points for readability
                    const chartHeight = 300;

                    // Calculate dynamic width based on number of data points
                    const chartWidth = leftMargin + (data.length * pointSpacing) + rightMargin;
                    svg.setAttribute('width', chartWidth);
                    svg.setAttribute('height', chartHeight);
                    svg.setAttribute('viewBox', `0 0 ${chartWidth} ${chartHeight}`);

                    // Find min and max values with padding
                    const scores = data.map(d => d.score);
                    const minScore = Math.max(0, Math.min(...scores) - 5); // Don't go below 0, add 5% padding
                    const maxScore = Math.min(100, Math.max(...scores) + 5); // Don't go above 100, add 5% padding
                    const scoreRange = maxScore - minScore;

                    // Chart dimensions
                    const plotHeight = chartHeight - topMargin - bottomMargin;
                    const plotWidth = chartWidth - leftMargin - rightMargin;
                    const plotTop = topMargin;
                    const plotBottom = chartHeight - bottomMargin;

                    // Create 5 grid lines and labels
                    for (let i = 0; i <= 4; i++) {
                        const value = minScore + (scoreRange * i / 4);
                        const y = plotBottom - (plotHeight * i / 4);

                        // Grid line
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', leftMargin);
                        line.setAttribute('y1', y);
                        line.setAttribute('x2', chartWidth - rightMargin);
                        line.setAttribute('y2', y);
                        line.setAttribute('stroke', '#e5e7eb');
                        line.setAttribute('stroke-width', '1');
                        gridLines.appendChild(line);

                        // Y-axis label
                        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        label.setAttribute('x', leftMargin - 10);
                        label.setAttribute('y', y + 4);
                        label.setAttribute('font-size', '12');
                        label.setAttribute('fill', '#6b7280');
                        label.setAttribute('text-anchor', 'end');
                        label.textContent = Math.round(value) + '%';
                        yAxisLabels.appendChild(label);
                    }

                    // Calculate coordinates for data points
                    const points = [];
                    data.forEach((point, index) => {
                        const x = leftMargin + (index * pointSpacing);
                        const normalizedScore = (point.score - minScore) / scoreRange;
                        const y = plotBottom - (normalizedScore * plotHeight);
                        points.push({ x, y, label: point.label, score: point.score });
                    });

                    // Build polyline points string
                    const linePoints = points.map(p => `${p.x},${p.y}`).join(' ');
                    trendLine.setAttribute('points', linePoints);

                    // Build polygon for filled area
                    const areaPoints = `${leftMargin},${plotBottom} ${linePoints} ${points[points.length-1].x},${plotBottom}`;
                    areaFill.setAttribute('points', areaPoints);

                    // Add circles and labels
                    points.forEach((p, index) => {
                        // Circle
                        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        circle.setAttribute('cx', p.x);
                        circle.setAttribute('cy', p.y);
                        circle.setAttribute('r', '5');
                        circle.setAttribute('fill', '#9333ea');
                        circle.setAttribute('stroke', 'white');
                        circle.setAttribute('stroke-width', '2');
                        dataPointsGroup.appendChild(circle);

                        // X-axis label
                        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        label.setAttribute('x', p.x);
                        label.setAttribute('y', plotBottom + 20);
                        label.setAttribute('font-size', '11');
                        label.setAttribute('fill', '#6b7280');
                        label.setAttribute('text-anchor', 'middle');
                        label.textContent = p.label;
                        dataPointsGroup.appendChild(label);

                        // Value label
                        const valueLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        valueLabel.setAttribute('x', p.x);
                        valueLabel.setAttribute('y', p.y - 10);
                        valueLabel.setAttribute('font-size', '12');
                        valueLabel.setAttribute('fill', '#9333ea');
                        valueLabel.setAttribute('text-anchor', 'middle');
                        valueLabel.setAttribute('font-weight', '600');
                        valueLabel.textContent = Math.round(p.score) + '%';
                        dataPointsGroup.appendChild(valueLabel);
                    });
                })();
                /*]]>*/
            </script>
        </div>
    </div>
</div>

<script>
  // Initialize Lucide icons
  lucide.createIcons();

  // Toggle grades function
  function toggleGrades(courseId) {
    const gradesDiv = document.getElementById(courseId + '-grades');
    const chevron = document.getElementById(courseId + '-chevron');

    if (gradesDiv.classList.contains('expanded')) {
      gradesDiv.classList.remove('expanded');
      chevron.setAttribute('data-lucide', 'chevron-down');
    } else {
      gradesDiv.classList.add('expanded');
      chevron.setAttribute('data-lucide', 'chevron-up');
    }

    // Re-initialize icons after changing
    lucide.createIcons();
  }

  // Add click handlers for mobile-friendly interaction
</script>
</body>
</html>